## Contents
 * [Obtaining the source code](#source)
 * [Installation of NVIDIA drivers (if you are using GPU)](#drivers)
 * [Building with Docker containers (recommended)](#with_docker)
 * [Building without Docker containers](#without_docker)

<a name="source"/>

## Obtaining the Source Code
We use Ubuntu 22.04 as an example.
```bash
cd ~
git clone --recurse-submodules https://github.com/rosteleset/frs.git
```

<a name="drivers"/>

## Installation of NVIDIA Drivers (if you are using GPU)
NVIDIA drivers should be installed on the host. Steps are described [here](https://docs.nvidia.com/datacenter/tesla/tesla-installation-notes/index.html#ubuntu-lts) or you may run:

```bash
$ sudo ~/frs/docker/setup_nvidia_drivers.sh
```
Reboot.

<a name="with_docker"/>

## Building with Docker

### System Requirements
* Docker and Docker-compose 1.28.0+ must be installed.
* 20 GB hard drive available space.

### Installation of NVIDIA Container Toolkit
Steps are described [here](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#getting-started) or just run:
```bash
sudo ~/frs/docker/setup_nvidia_container_toolkit.sh
```

### Configuration
Set environment variables:
* FRS_HOST_WORKDIR - working directory on the host;
* MYSQL_DB - database name of a running MySQL container;
* MYSQL_PORT - MySQL port of a running container;
* MYSQLX_PORT - port for MySQL X plugin;
* MYSQL_PASSWORD - root password of a running MySQL container.
* WITH_GPU - GPU using flag.

And run *prepare_config.sh* script, for a example:
```bash
cd ~/frs/docker
sudo \
FRS_HOST_WORKDIR=/opt/frs \
MYSQL_DB=db_frs \
MYSQL_PORT=3306 \
MYSQLX_PORT=33060 \
MYSQL_PASSWORD=123123 \
WITH_GPU=1 \
./prepare_config.sh
```
Omit WITH_GPU=1 or use WITH_GPU=0 for configuration without GPU. Now directory */opt/frs* should contain all necessary files for running FRS.

### Building FRS Docker Container
```bash
cd ~/frs/docker
sudo ./build_frs.sh
```
If your password for SQL database contains special characters than you need to escape them using hexadecimal format %xx in /opt/frs/frs.config file. For example, password 123@123 should be set as 123%40123

### Running FRS
* With GPU:
```bash
sudo docker-compose -f /opt/frs/docker-compose-gpu.yml up
```
* Without GPU:
```bash
sudo docker-compose -f /opt/frs/docker-compose-cpu.yml up
```

<a name="without_docker"/>

## Building without Docker

### Building NVIDIA Container Toolkit
Use official [documentation](https://github.com/triton-inference-server/server/blob/main/docs/customization_guide/build.md#building-without-docker).

### Installing Dependencies
```bash
sudo apt-get --yes install make lsb-release software-properties-common wget unzip git libssl-dev rapidjson-dev libz-dev cmake libopencv-dev libboost-filesystem-dev libboost-program-options-dev libboost-date-time-dev libboost-system-dev libboost-thread-dev clang-14 lldb-14 lld-14 clangd-14
```

### Building Triton Client Libraries
```bash
export CC=clang-14
export CXX=clang++-14
cd ~
git clone https://github.com/triton-inference-server/client.git triton-client
cd triton-client
git checkout r22.04
mkdir build && cd build
cmake \
-DCMAKE_BUILD_TYPE=Release \
-DCMAKE_CXX_STANDARD=20 \
-DCMAKE_INSTALL_PREFIX:PATH=$HOME/triton-client/build/install \
-DTRITON_ENABLE_CC_HTTP=ON \
-DTRITON_ENABLE_CC_GRPC=OFF \
-DTRITON_ENABLE_PERF_ANALYZER=OFF \
-DTRITON_ENABLE_PYTHON_HTTP=OFF \
-DTRITON_ENABLE_PYTHON_GRPC=OFF \
-DTRITON_ENABLE_GPU=OFF \
-DTRITON_ENABLE_EXAMPLES=OFF \
-DTRITON_ENABLE_TESTS=OFF \
-DTRITON_COMMON_REPO_TAG=r22.04 \
-DTRITON_THIRD_PARTY_REPO_TAG=r22.04 \
..
make cc-clients -j`nproc`
```

### Building FRS
```bash
export CC=clang-14
export CXX=clang++-14
cd ~/frs && mkdir build && cd build
cmake \
-DCMAKE_BUILD_TYPE=Release \
-DTRITON_CLIENT_DIR:PATH=$HOME/triton-client/build/install \
-DCURL_ZLIB=OFF \
-DWEB_STATIC_DIRECTORY:STRING="/opt/frs/static/" \
..
make -j`nproc`
```
Make working directory for FRS and copy needed for configuration files:
```bash
sudo cp -R ~/frs/opt/ /opt/frs/
sudo chown $USER:$USER /opt/frs -R
cp ~/frs/build/frs /opt/frs
```

### Generating TensorRT Plans (if you are using GPU)
Plans can be generated by means of *trtexec* which ships with TensorRT.
scrfd:
```bash
mkdir -p /opt/frs/model_repository/scrfd/1/
trtexec --onnx=/opt/frs/plan_source/scrfd/scrfd_10g_bnkps.onnx --saveEngine=/opt/frs/model_repository/scrfd/1/model.plan --shapes=input.1:1x3x320x320
```
genet:
```bash
mkdir -p /opt/frs/model_repository/genet/1/
trtexec --onnx=/opt/frs/plan_source/genet/genet_small_custom_ft.onnx --saveEngine=/opt/frs/model_repository/genet/1/model.plan
```
arcface:
```bash
mkdir -p /opt/frs/model_repository/arcface/1/
mkdir -p /opt/frs/plan_source/arcface/
# download file glint360k_r50.onnx
wget --quiet https://nc2.lanta.me/s/HpjwAsoWr2XYek5/download -O /opr/frs/plan_source/arcface/glint360k_r50.onnx
trtexec --onnx=/opt/frs/plan_source/arcface/glint360k_r50.onnx --saveEngine=/opt/frs/model_repository/arcface/1/model.plan --shapes=input.1:1x3x112x112
```

### Configuration without GPU
scrfd:
```bash
mkdir -p /opt/frs/model_repository_onnx/scrfd/1/
mv /opt/frs/plan_source/scrfd/scrfd_10g_bnkps.onnx /opt/frs/model_repository_onnx/scrfd/1/model.onnx
```
genet:
```bash
mkdir -p /opt/frs/model_repository_onnx/genet/1/
mv /opt/plan_source/genet/genet_small_custom_ft.onnx /opt/model_repository_onnx/genet/1/model.onnx
```
arcface:
```bash
mkdir -p /opt/frs/model_repository_onnx/arcface/1/
# download file glint360k_r50.onnx
wget --quiet https://nc2.lanta.me/s/HpjwAsoWr2XYek5/download -O /opt/frs/model_repository_onnx/arcface/1/model.onnx
```

### Installing and Configuring MySQL Server
```bash
sudo apt install mysql-server
```
In configuration file */etc/mysql/mysql.conf.d/mysqld.cnf*  uncomment lines with **mysqlx-bind-address** option. We recommend turn off binary logging and add these lines to the configuration file:
```
skip-log-bin
innodb_flush_log_at_trx_commit =  2
innodb_flush_log_at_timeout    = 10
```
And run commands:
```bash
sudo service mysql start
sudo mysql_secure_installation
```
Next you should create user and database in MySQL shell:
```sql
CREATE USER 'user_frs'@'localhost' IDENTIFIED BY '123123';
CREATE DATABASE db_frs;
GRANT ALL PRIVILEGES ON db_frs.* TO 'user_frs'@'localhost' WITH GRANT OPTION;
```
Put initial data in database:
```bash
mysql -p -u user_frs db_frs < ~/frs/mysql/01_structure.sql
mysql -p -u user_frs db_frs < ~/frs/mysql/02_default_data.sql
```

### Running Triton Inference Server
* With GPU:
```bash
tritonserver --model-repository=/opt/frs/model_repository
```
* Without GPU:
```bash
tritonserver --model-repository=/opt/frs/model_repository_onnx
```

### Running FRS
FRS configuration parameters are located in the file */opt/frs/sample.config*.
Running:
```bash
/opt/frs/run_frs
```
